@{
    Layout = "_CommonMasterLayout";  // Using your master layout
    ViewData["Title"] = "Mark Attendance via Webcam";
}

<div class="container py-5">
    <div class="row">
        <div class="col-md-12 text-center">
            <h1 class="display-4 mb-4">@ViewData["Title"]</h1>
            <p class="lead">Please capture your photo to mark your attendance.</p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-6 text-center">
            <!-- Video element to display webcam feed -->
            <div class="webcam-container mb-3">
                <video id="webcam" autoplay playsinline class="border rounded" style="width: 100%; height: auto;"></video>
            </div>

            <!-- Button to capture photo -->
            <button id="captureButton" class="btn btn-primary btn-lg mb-3">
                <i class="fas fa-camera"></i> Capture Photo
            </button>

            <!-- Canvas to hold the captured image -->
            <canvas id="canvas" style="display:none;" width="400" height="300"></canvas>

            <!-- Image element to display the captured photo -->
            <div class="captured-image-container">
                <img id="capturedImage" class="border rounded" style="display:none; width: 100%; height: auto;" />
            </div>

            <!-- Hidden field to send the captured image data to the server -->
            <input type="hidden" id="imageData" name="imageData" />

            <!-- Button to submit attendance -->
            <button id="submitAttendance" class="btn btn-success btn-lg mt-3" style="display:none;">
                <i class="fas fa-check"></i> Submit Attendance
            </button>
        </div>
    </div>
</div>

@section VendorScripts {
    <!-- FontAwesome for icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
}

@section PageScripts {
    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const capturedImage = document.getElementById('capturedImage');
        const imageDataInput = document.getElementById('imageData');
        const submitButton = document.getElementById('submitAttendance');

        // Access the user's webcam
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true }).then(function (stream) {
                video.srcObject = stream;
            }).catch(function (error) {
                alert('Unable to access webcam. Please check your camera settings.');
            });
        }

        // Capture the image from the webcam when the button is clicked
        document.getElementById('captureButton').addEventListener('click', function () {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert canvas to base64 image and display it
            const imageData = canvas.toDataURL('image/png');
            capturedImage.src = imageData;
            capturedImage.style.display = 'block';
            imageDataInput.value = imageData;
            submitButton.style.display = 'inline-block';
        });

        // Submit attendance
        document.getElementById('submitAttendance').addEventListener('click', function () {
            const formData = new FormData();
            formData.append('imageData', imageDataInput.value);

            fetch('/Attendance/SubmitAttendance', {
                method: 'POST',
                body: formData
            }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Attendance marked successfully!');
                    } else {
                        alert('Failed to mark attendance.');
                    }
                });
        });
    </script>
}
